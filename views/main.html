
<!DOCTYPE html>
<html lang="en">
<head>
	
	<title>Proches Et Vous !</title>
  <script src="../js/Adapters/DBRepository.js"></script>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

	<!-- CSS Whovians CSS -->
	<link href="../styles/homePageStyles.css" rel="stylesheet">
	

<style>
	body {
	  margin: 2px;
	}

	ul {
	font-size: 28px;
	list-style-type: none;
	margin: 5px;
	padding: 5px;
	width: 18%;
	background-color: #f1f1f1;
	position: fixed;
	height: 25%;
	/*overflow: auto;*/
	float: right;
	text-align: center;
	border: 2px solid yellow;

	}

	li {
	border: 2px solid red;
	height: 50%;
	margin: 5% 0 15% 0;
	padding: 5%;
	}

	li a {
	  display: block;
	  color: #000;
	  text-decoration: none;
	}

	li a.active {
	  background-color: #04AA6D;
	  color: white;
	}

	li a:hover:not(.active) {
	  background-color: #555;
	  color: white;
	}
	.leaflet-container {
		display: block;
		width: 85%;
		height: 95%;
		}
</style>

	
</head>
<body>


<div style="margin-left:80%;padding:2px 2px;height:100px;">
<ul>
	<li>
	  <iframe src="homePage.html" name="calendar" style="border:2px solid red;" title="Iframe Calendrier">
		<a href="homePage.html" target="calendar">
		<!-- piste, getElemByID.show: Hidden/visible  -->
			<img src="../img/calendrier.png" alt="Calendrier" class="avatar">
		</a>
	  </iframe>
	</li>
	<li>
		<a href="profil_page.html">
			<img src="../img/avatar.png" alt="Photo de profil" class="avatar">
		</a>
	</li>
</ul>
</div>

<div style="margin-right:8%;padding:2px 2px;height:1000px;">
<div id="map" style="margin-right:8%;padding:2px 2px;height:1000px;"></div>
	<script>
	
	
		var map = L.map('map').setView([50.465826, 4.85769], 17);

		var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
			maxZoom: 30,
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
				'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
			id: 'mapbox/streets-v11',
			tileSize: 512,
			zoomOffset: -1
		}).addTo(map);
		
	/*  -------  VOUS ETES ICI ------- */

  let user_long = 4.85769;
  let user_lat = 50.465826;
  let setUserPositionMarker = function(){
    DBRepository.getUser(1, function(user){
      var userAvatarIcon = new LeafIcon({iconUrl: '../img/'+user.avatar_filename});
      var marker = L.marker([user_lat, user_long], {icon: userAvatarIcon}).addTo(map)
			  .bindPopup('<b>Bonjour '+user.fullname+'</b><br />Vous êtes ici.').openPopup();
    });
  }
    navigator.geolocation.getCurrentPosition(function(position){
        user_lat  = position.coords.latitude;
        user_long = position.coords.longitude;
        console.log(user_lat+" "+user_long);
        setUserPositionMarker();
      }, function(){
        setUserPositionMarker();
      });


	/* -------  Définition des attributs des icones  ------- */
		var LeafIcon = L.Icon.extend({
			options: {
			shadowUrl: 'leaf-shadow.png',
			iconSize:     [60, 60],
			//shadowSize:   [50, 64],
			iconAnchor:   [22, 94],
			shadowAnchor: [5, 5],
			popupAnchor:  [-3, -76]
			}
		});

	/* -------  Définition des 3 icones de catégories  ------- */
	let sportsICO = new LeafIcon({iconUrl: '../img/sportsICO.jpg'});
  let cultureICO = new LeafIcon({iconUrl: '../img/cultureICO.png'});
  let gamesICO = new LeafIcon({iconUrl: '../img/gamesICO.jpg'});


	L.icon = function (options) {
    return new L.Icon(options);
	};
	
	/*  -------  Positionnement d'icones d'activités ==> Dévelloper une fonction qui parcoure la DB ------- */
  DBRepository.getAllEvents(function(event_list){
    console.log(event_list.length);
    event_list.forEach(event_item => {
      console.log(event_item.category_type);
      const event_icon = new LeafIcon({iconUrl: '../img/cultureICO.png'});
        if(event_item.category_type === "Sport") {
          event_icon = new LeafIcon({iconUrl: '../img/sportsICO.jpg'});
        } else if(event_item.category_type === "Jeux") {
          event_icon = new LeafIcon({iconUrl: '../img/gamesICO.jpg'});
        }
        //http://open.mapquestapi.com/geocoding/v1/address?key=KEY&location=Washington,DC
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "http://open.mapquestapi.com/geocoding/v1/address?key="+"RaEacuhNAZEHQ3ArwIntrabbpiq9aHvT"+"&location="+encodeURIComponent(event_item.location), false ); // false for synchronous request
        xmlHttp.send( null );
        const event_lat = JSON.parse(xmlHttp.responseText).results[0].locations[0].latLng.lat;
        const event_lng = JSON.parse(xmlHttp.responseText).results[0].locations[0].latLng.lng;
        L.marker([event_lat, event_lng], {icon: event_icon}).addTo(map).bindPopup(event_item.title);
    });
  });

	/*  -------  Choix des catégories ------- */
/*	
var 
    sportss    = L.marker([50.467386, 4.857674], {icon: sportsICO}).addTo(map).bindPopup("Activité sportive.");
    cult    = L.marker([50.465405, 4.862437], {icon: cultureICO}).addTo(map).bindPopup("Activité culturelle.");
    gamess    = L.marker([50.46369, 4.859101], {icon: gamesICO}).addTo(map).bindPopup("Activité récréative.");
Instead of adding them directly to the map, you can do the following, using the LayerGroup class:

var sp = L.layerGroup([sportss]);
var cu = L.layerGroup([cult]);
var ga = L.layerGroup([gamess]);
	
	var overlayMaps = {
    "Sports": sp
	"Culture": cu
	"Jeux": ga
};
	
	L.control.layers(overlayMaps).addTo(map);
*/	
	

	/*  -------  Fonction affichant les coordonnées de l'endroit cliqué ------- */
var popup = L.popup();

function onMapClick(e) {
    popup
        .setLatLng(e.latlng)
        .setContent("Vous avez cliqué en : " + e.latlng.toString())
        .openOn(map);
}

map.on('click', onMapClick);

	</script>

</div>




</body>
</html>
