<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Proche Et Vous</title>

		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
			integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
			crossorigin="" />
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
			integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
			crossorigin=""></script>


	<style>

		* {
			padding: 0;
			margin: 0;
			box-sizing: border-box;
		}

		html {
			font-size: 62.5%;
		}

		body {
			height: 100vh;
			font-size: 1.6rem;
		}

		#header {
			height: 10rem;
			background-color: gray;
		}
		.btn navbar-btn{
			display: inline;
		}


		#content {
			position: relative;;
			width: 100%;
			height: calc(100% - 10rem);
		}

		#sidebar {
			position: absolute;
			top: 0;
			right: 0;
			width: 20%;
			height: 100%;
			background-color: rgb(102, 102, 102);
			transition: .5s transform;
			 z-index: 10000;
		}

		.avatar {
			/*position: absolute;*/
			top: 0;
			right: 0;
			width: 50px;
			height: 50px;
			border-radius: 10%;
		}

		#sidebar.open {
			transform: translateX(100%);
		}

		#sidebar.close {
			transform: translateX(100%);
		}

		.sidebar-btn {
			position: absolute;
			top: 0;
			left: -6rem;
			width: 6rem;
			height: 5rem;
			border: .1rem solid black;
			background-color: rgb(204, 103, 103);
		}

		#map {
			background-color: whitesmoke;
			width: 100%;
			height: 100%;
		}

		/*
		.leaflet-container {
			display: block;
			width: 85%;
			}
		*/

	</style>

</head>
<body>
	<nav class="navbar bg-navbar" style="background-color:#ccffcc;">
		<div class="container">
			<div class="navbar-header">
			  <a class="navbar-brand" href="#">
				  <img src="../img/logo_squared.png" width="70" height="70" alt="">
			  </a>
			  <span class="nav navbar-nav pull-xs-right">
				<a href="profil_page.html">
					<button type="button" class="btn navbar-btn"> <img src="../img/avatar.png" height="80" width="80" />
					</button>
				</a>
			</nav>
			</div>
			
		  </div>
	</nav>



	<!-- <div id="header">
		
	</div>-->

	<div id="content">
		<div id="map"></div>
			<div id="sidebar">
							<!--  Bouton CALENDRIER  -->
				<div class="sidebar-btn">
						<img src="../img/calendrier.png" alt="Calendrier" class="avatar">
				</div>
				<div><!----  --------------- AGENDA  ------------------------- -->
					<div class="calendar">
						<div class="headCalendar">
							<i class="fas fa-angle-left prev" id="prevWeek"></i>
							<div class="row">
								<h1>Semaine du 21/02 au 27/02</h1>
								<h3 class="semaine"></h3>
							</div>
							<i class="fas fa-angle-right next" id="nextWeek"></i>
						</div>
					
						<div id="agenda_mainpage">
							<h2>Lundi</h2>
              <p id="agenda_lundi"></p>
							<h2>Mardi</h2>
              <p id="agenda_mardi"></p>
							<h2>Mercredi</h2>
              <p id="agenda_mercredi"></p>
							<h2>Jeudi</h2>
              <p id="agenda_jeudi"></p>
							<h2>Vendredi</h2>
              <p id="agenda_vendredi"></p>
							<h2>Samedi</h2>
              <p id="agenda_samedi"></p>
							<h2 style="color: red;">Dimanche</h2>
              <p id="agenda_dimanche"></p>
						</div>
						<script src="../js/Model/EventParticipation.js"></script>
						<script src="../js/Adapters/DBRepository.js"></script>
						<script src="../js/Agenda/agenda.js"></script>
					</div>
				</div>
			<div>

				
		</div>
		
	</div>

	</div>

	<script>
		const sidebar = document.getElementById('sidebar');
		const sidebar_btn = document.querySelector('.sidebar-btn');

		sidebar_btn.addEventListener('click', function (event) {
				console.log('click');
				if (sidebar.classList.contains('open')) {
					sidebar.classList.remove('open');
				} else {
					sidebar.classList.add('open');
				}
		})
	</script>

	<script>
		var map = L.map('map').setView([50.465826, 4.85769], 17);
		var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
			maxZoom: 30,
			attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
				'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
			id: 'mapbox/streets-v11',
			tileSize: 512,
			zoomOffset: -1
		}).addTo(map);


		/*  -------  VOUS ETES ICI ------- */
		
		let user_long = 4.85769;
		let user_lat = 50.465826;
    let current_user_location_address = "";
		let setuserPositionMarker = function(){
			DBRepository.getUser(1, function(user){
			var userAvatarIcon = new LeafIcon({iconUrl: '../img/'+user.avatar_filename});
			var marker = L.marker([user_lat, user_long], {icon: userAvatarIcon}).addTo(map)
				.bindPopup('<p>Bonjour '+user.fullname+'<p><br/>Vous êtes ici.').openPopup();
			});
		}
		navigator.geolocation.getCurrentPosition(
      function(position){
		    user_lat = position.coords.latitude;
		    user_long = position.coords.longitude;
		    console.log(user_lat+" "+user_long);
        var xmlHttp = new XMLHttpRequest();
        //http://www.mapquestapi.com/geocoding/v1/reverse?key=RaEacuhNAZEHQ3ArwIntrabbpiq9aHvT&location=30.333472,-81.470448&includeRoadMetadata=true&includeNearestIntersection=true
        xmlHttp.open( "GET", "http://www.mapquestapi.com/geocoding/v1/reverse?key=RaEacuhNAZEHQ3ArwIntrabbpiq9aHvT&location="+user_lat+","+user_long+"&includeRoadMetadata=true&includeNearestIntersection=true", false ); // false for synchronous request
        xmlHttp.send( null );
        let location_object = JSON.parse(xmlHttp.responseText).results[0].locations[0];
        current_user_location_address = location_object.street +", "+ location_object.adminArea1Type;
        console.log(current_user_location_address);
		    setuserPositionMarker(); 
		}, function(){setuserPositionMarker();}, {timeout:10000});


    /* -------  Définition des attributs des icones  ------- */
		var LeafIcon = L.Icon.extend({
			options: {
				shadowUrl: 'leaf-shadow.png',
				iconSize: [60, 60],
				//shadowSize:   [50, 64],
				iconAnchor: [22, 94],
				shadowAnchor: [5, 5],
				popupAnchor: [-3, -76]
			}
		});
		/* -------  Définition des 3 icones de catégories  ------- */
		var sportsICO = new LeafIcon({ iconUrl: '../img/sportsICO.jpg' }),
			cultureICO = new LeafIcon({ iconUrl: '../img/cultureICO.jpg' }),
			gamesICO = new LeafIcon({ iconUrl: '../img/gamesICO.jpg' });
		L.icon = function (options) {
			return new L.Icon(options);
		};
		/*  -------  Fonction affichant les coordonnées de l'endroit cliqué ------- */
		var popup = L.popup();

		function onMapClick(e) {
			popup
				.setLatLng(e.latlng)
				.setContent("Vous avez cliqué en : " + e.latlng.toString())
				.openOn(map);
		}

	/* -------  Définition des 3 icones de catégories  ------- */
	let a_sportsICO = new LeafIcon({iconUrl: '../img/sportsICO.png'});
  	let a_cultureICO = new LeafIcon({iconUrl: '../img/cultureICO.png'});
  	let a_gamesICO = new LeafIcon({iconUrl: '../img/gamesICO.png'});


	L.icon = function (options) {
    return new L.Icon(options);
	};
	
  function jeparticipe(event_id_a){
    console.log("je participe " + event_id_a);
    DBRepository.addEventParticipation({user_id: 1, event_id: event_id_a, eventparticipation_id: null}, function(){
      refreshAgenda();
    });
  }
  function voirparticipants(){
    console.log("participants");
  }

	/*  -------  Positionnement d'icones d'activités ==> Dévelloper une fonction qui parcoure la DB ------- */
  let marker_list = [];
  DBRepository.getAllEvents(function(event_list){
    console.log(event_list.length);
    event_list.forEach(event_item => {
      console.log(event_item.category_type);
      let event_icon = a_cultureICO;
        if(event_item.type === "Sport") {
          event_icon = a_sportsICO;
        } else if(event_item.type === "Jeux") {
          event_icon = a_gamesICO;
        }
        //http://open.mapquestapi.com/geocoding/v1/address?key=KEY&location=Washington,DC
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "http://open.mapquestapi.com/geocoding/v1/address?key="+"RaEacuhNAZEHQ3ArwIntrabbpiq9aHvT"+"&location="+encodeURIComponent(event_item.location), false ); // false for synchronous request
        xmlHttp.send( null );
        const event_lat = JSON.parse(xmlHttp.responseText).results[0].locations[0].latLng.lat;
        const event_lng = JSON.parse(xmlHttp.responseText).results[0].locations[0].latLng.lng;
        const event_marker = L.marker([event_lat, event_lng], {icon: event_icon}).addTo(map).bindPopup("<h2>"+event_item.title + '</h2><br/>' + event_item.begindate +" - "+ event_item.endingdate +'<br/>'+ event_item.description
        + '<div id=\"participant_div\"></div><br/><button onClick=\"jeparticipe('+event_item.event_id+')\">Je participe</button>'/* + '<button style=\"margin-left:5px;\">Participants</button>'*/);
        marker_list.push({event_id: event_item.event_id, marker: event_marker});
      });
  });


  	/*  -------  AFFICHAGE/POPULATE DU CALENDRIER DANS LA SIDEBAR ------- */
    function selectMarker(event_id, event_location){
      marker_list.forEach(marker_item => {
        if(marker_item.event_id === event_id){
          marker_item.marker.openPopup();
        }
      });
      //http://www.mapquestapi.com/directions/v2/route?key=RaEacuhNAZEHQ3ArwIntrabbpiq9aHvT&from=Clarendon Blvd,Arlington,VA&to=2400+S+Glebe+Rd,+Arlington,+VA
      var xmlHttp = new XMLHttpRequest();
      //xmlHttp.open( "GET", "http://www.mapquestapi.com/directions/v2/route?key=RaEacuhNAZEHQ3ArwIntrabbpiq9aHvT&from="+encodeURIComponent(current_user_location_address)+"&to="+encodeURIComponent(event_location), false ); // false for synchronous request
      ////console.log("http://www.mapquestapi.com/directions/v2/route?key=RaEacuhNAZEHQ3ArwIntrabbpiq9aHvT&from="+current_user_location_address+"&to="+event_location);
      //xmlHttp.send( null );
      //console.log(xmlHttp.responseText);
      //let location_object = JSON.parse(xmlHttp.responseText).results[0];
      //console.log(location_object.length);

    }
    function refreshAgenda(){
      document.getElementById("agenda_dimanche").innerHTML="";
      document.getElementById("agenda_lundi").innerHTML="";
      document.getElementById("agenda_mardi").innerHTML="";
      document.getElementById("agenda_mercredi").innerHTML="";
      document.getElementById("agenda_jeudi").innerHTML="";
      document.getElementById("agenda_vendredi").innerHTML="";
      document.getElementById("agenda_samedi").innerHTML="";
      DBRepository.getParticipations(1, function (participation_list) {
			  console.log(participation_list.length);
        participation_list.forEach(participation => {
					DBRepository.getEvent(participation.event_id, function(event_item){
						let eventdate_day = new Date(event_item.begindate).getDay();
            let agendapositionelement = null;
            switch(eventdate_day){
              case 4: agendapositionelement = document.getElementById("agenda_dimanche"); break;
              case 5: agendapositionelement = document.getElementById("agenda_lundi"); break;
              case 6: agendapositionelement = document.getElementById("agenda_mardi"); break;
              case 0: agendapositionelement = document.getElementById("agenda_mercredi"); break;
              case 1: agendapositionelement = document.getElementById("agenda_jeudi"); break;
              case 2: agendapositionelement = document.getElementById("agenda_vendredi"); break;
              case 3: agendapositionelement = document.getElementById("agenda_samedi"); break;
            }
				    agendapositionelement.innerHTML += "<p onClick='selectMarker("+event_item.event_id+", \""+event_item.location+"\")'>"+event_item.title+" - "+event_item.begindate+"</p><br/>"
			    });
		    });
      });
    }
    refreshAgenda(); // execute first time.
		
	/*  -------  Fonction affichant les coordonnées de l'endroit cliqué ------- */

  var popup = L.popup();

	</script>


	<!--jQuery(necessary for Bootstrap's JavaScript plugins) -->
	<script src = "https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" ></script>
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="js/bootstrap.min.js"></script>


</body>
</html>